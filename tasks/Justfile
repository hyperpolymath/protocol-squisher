# SPDX-License-Identifier: PMPL-1.0-or-later
# protocol-squisher - Justfile
# https://just.systems/man/en/

set shell := ["bash", "-uc"]
set dotenv-load := true
set positional-arguments := true

# Project metadata
project := "protocol-squisher"
version := "0.1.0"

# ═══════════════════════════════════════════════════════════════════════════════
# DEFAULT & HELP
# ═══════════════════════════════════════════════════════════════════════════════

# Show all available recipes
default:
    @just --list --unsorted

# Show project info
info:
    @echo "Project: {{project}}"
    @echo "Version: {{version}}"

# ═══════════════════════════════════════════════════════════════════════════════
# BUILD
# ═══════════════════════════════════════════════════════════════════════════════

# Build the project
build:
    @echo "Building {{project}}..."
    cargo build --workspace

# Clean build artifacts
clean:
    @echo "Cleaning..."
    cargo clean

# ═══════════════════════════════════════════════════════════════════════════════
# TEST & QUALITY
# ═══════════════════════════════════════════════════════════════════════════════

# Run tests
test:
    @echo "Running tests..."
    cargo test --workspace

# Run linter
lint:
    @echo "Linting..."
    cargo clippy --workspace -- -D warnings

# Format code
fmt:
    @echo "Formatting..."
    cargo fmt --all -- --check

# Run all quality checks
quality: fmt lint test

# ═══════════════════════════════════════════════════════════════════════════════
# VALIDATION
# ═══════════════════════════════════════════════════════════════════════════════

# Validate RSR compliance
validate-rsr:
    @echo "Validating RSR compliance..."
    @test -f .gitignore || (echo "Missing .gitignore" && exit 1)
    @test -f .gitattributes || (echo "Missing .gitattributes" && exit 1)
    @test -f .editorconfig || (echo "Missing .editorconfig" && exit 1)
    @test -f .tool-versions || (echo "Missing .tool-versions" && exit 1)
    @test -f .machines_readable/6scm/META.scm || (echo "Missing .machines_readable/6scm/META.scm" && exit 1)
    @test -f .machines_readable/6scm/STATE.scm || (echo "Missing .machines_readable/6scm/STATE.scm" && exit 1)
    @test -f .machines_readable/6scm/ECOSYSTEM.scm || (echo "Missing .machines_readable/6scm/ECOSYSTEM.scm" && exit 1)
    @test -f .machines_readable/6scm/PLAYBOOK.scm || (echo "Missing .machines_readable/6scm/PLAYBOOK.scm" && exit 1)
    @test -f .machines_readable/6scm/AGENTIC.scm || (echo "Missing .machines_readable/6scm/AGENTIC.scm" && exit 1)
    @test -f .machines_readable/6scm/NEUROSYM.scm || (echo "Missing .machines_readable/6scm/NEUROSYM.scm" && exit 1)
    @test ! -f Makefile || (echo "Makefile forbidden - use justfile" && exit 1)
    @echo "RSR validation passed!"

# Validate STATE.scm syntax
validate-state:
    @echo "Validating .machines_readable/6scm/STATE.scm..."
    @test -f .machines_readable/6scm/STATE.scm && echo "STATE.scm exists" || echo "STATE.scm missing"

# Update STATE.scm timestamp
state-touch:
    @echo "Updating STATE.scm timestamp..."
    @[ -f .machines_readable/6scm/STATE.scm ] && sed -i 's/(updated . "[^"]*")/(updated . "'$(date +%Y-%m-%d)'")/' .machines_readable/6scm/STATE.scm || true

# ═══════════════════════════════════════════════════════════════════════════════
# CI
# ═══════════════════════════════════════════════════════════════════════════════

# Run full CI pipeline locally
ci: quality validate-rsr
    @echo "CI pipeline passed!"
