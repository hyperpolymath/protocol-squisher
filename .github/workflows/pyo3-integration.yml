# SPDX-License-Identifier: PMPL-1.0-or-later
# SPDX-FileCopyrightText: 2025 hyperpolymath

name: PyO3 Integration Tests

on:
  push:
    branches: [main]
    paths:
      - 'tests/pyo3-integration/**'
      - 'crates/protocol-squisher-pyo3-codegen/**'
      - '.github/workflows/pyo3-integration.yml'
  pull_request:
    branches: [main]
    paths:
      - 'tests/pyo3-integration/**'
      - 'crates/protocol-squisher-pyo3-codegen/**'
      - '.github/workflows/pyo3-integration.yml'

permissions: read-all

jobs:
  test:
    name: PyO3 Integration Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12', '3.13']

    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b # stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2
        with:
          workspaces: tests/pyo3-integration

      - name: Install maturin
        run: pip install maturin pytest

      - name: Build and test
        working-directory: tests/pyo3-integration
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install pytest maturin
          maturin develop
          pytest python/tests -v
